@let isUserLoggedIn = sessionService.isLoggedIn();

<div class="sticky-container">
  <mat-accordion class="header-align">
    <mat-expansion-panel [expanded]="!isUserLoggedIn">
      <mat-expansion-panel-header>
        <mat-panel-title>
          Github
          @if (isUserLoggedIn) {
            &nbsp;&nbsp;
            <i class="fa-solid fa-circle-check fa-cl-success"></i>
            &nbsp;&nbsp;
            <i matRipple matTooltip="re-sync user info" (click)="syncInfo($event)"
               class="fa-solid fa-arrows-rotate"></i>
          }
        </mat-panel-title>
        <mat-panel-description>
          @if (isUserLoggedIn) {
            <span>&nbsp;</span>
            <small>
              <div>Admin: Last synced on {{ sessionService.getUser().lastSync | date: 'YYYY-MM-dd hh:mm a' }}</div>
              <div>Sync type: Full</div>
            </small>
          }
        </mat-panel-description>
      </mat-expansion-panel-header>
      @if (!isUserLoggedIn) {
        <div class="integration-content">
          <button mat-flat-button color="primary" (click)="onGHLogin()">Connect</button>
          <div>Connect Sred.io to Github</div>
        </div>
      } @else {
        <div class="integration-content align-end">
          <button mat-flat-button color="warn" (click)="onGHLogout()">Remove <i class="fa-solid fa-user-secret"></i>
          </button>
        </div>
      }
    </mat-expansion-panel>
  </mat-accordion>

  @if (isUserLoggedIn) {
    <div class="fields-container">
      <mat-form-field>
        <mat-label>Integration</mat-label>
        <mat-select [(ngModel)]="integration">
          <mat-option value="github">Github</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field floatLabel="always">
        <mat-label>Search</mat-label>
        <input #searchField #searchModel='ngModel' [disabled]="loadingSearchResults || loadingCommits || loadingIssues"
               matInput [(ngModel)]="searchTerm"/>
      </mat-form-field>
    </div>
  }
</div>

@if (isUserLoggedIn) {
  <div class="data-container mat-elevation-z4">
    <div [ngxLoaderIndicator]="loadingCommits || loadingSearchResults">
      @if (!commitsSearchResult?.length && !this.searchTerm().length) {
        <app-gh-data-grid [data]="(commits$ | async)!" collectionName="Repo Commits"
                          (pageChange)="handlePageChange('Repo Commits', $event )"
                          [pageSize]="PageSize"></app-gh-data-grid>
      } @else {
        <app-gh-data-grid collectionName="Repo Commits Search Results"
                          [searchResults]="commitsSearchResult"
                          (pageChange)="handlePageChange('Repo Commits', $event )"
                          [pageSize]="PageSize"></app-gh-data-grid>
      }
    </div>
    <div [ngxLoaderIndicator]="loadingIssues || loadingSearchResults">
      @if (!issuesSearchResult?.length  && !this.searchTerm().length) {

        <app-gh-data-grid [data]="(issues$ | async)!" collectionName="Repo Issues"
                          (pageChange)="handlePageChange('Repo Issues', $event )"
                          [pageSize]="PageSize"></app-gh-data-grid>
      } @else {
        <app-gh-data-grid collectionName="Repo Issues Search Results"
                          [searchResults]="issuesSearchResult"
                          (pageChange)="handlePageChange('Repo Issues', $event )"
                          [pageSize]="PageSize"></app-gh-data-grid>
      }
    </div>
    <div [ngxLoaderIndicator]="loadingOrgs">
      <app-gh-data-grid [data]="(orgs$ | async)!" collectionName="Organizations"
                        (pageChange)="handlePageChange('Organizations', $event )"
                        [pageSize]="PageSize"></app-gh-data-grid>
    </div>
    <div [ngxLoaderIndicator]="loadingRepos">
      <app-gh-data-grid [data]="(repos$ | async)!" collectionName="Repos"
                        (pageChange)="handlePageChange('Repos', $event )" [pageSize]="PageSize"></app-gh-data-grid>
    </div>
    <div [ngxLoaderIndicator]="loadingPulls">
      <app-gh-data-grid [data]="(pulls$ | async)!" collectionName="Repo Pull Requests"
                        (pageChange)="handlePageChange('Repo Pull Requests', $event )"
                        [pageSize]="PageSize"></app-gh-data-grid>
    </div>
  </div>
}
